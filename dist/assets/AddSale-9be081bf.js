import{cL as ne,cM as E,r as C,cN as e,d9 as ue,cV as se,c_ as me,cO as pe}from"./vendor-3a94a37a.js";import{al as xe,C as he,aX as je,aP as ie,cy as ye,d as ge,ac as fe,a1 as be,cz as Ne,a$ as we,cA as ve}from"./index-ed7845ca.js";import{u as Ce}from"./useCurrency-4b14dd3d.js";import{S as Ie}from"./Search-32fc9847.js";import{F as d,b as h,h as M,P as Se,D as te,I as X,B as Ae}from"./vendor-large-f75deccb.js";import{A as Pe}from"./AddCustomer-f6c915fd.js";import{B as ae}from"./BigDrawer-240149a9.js";import{A as Ve}from"./AddTermsAndConditions-4921265d.js";import{P as Te}from"./Payments-4aa4b64f.js";import"./UploadMany-c4472299.js";function Fe({form:g,productList:I,productLoading:O,totalCalculator:f,subTotal:S}){const T=Ce(),_=ne(),{list:F,loading:b,defaultStore:B}=E(u=>u.store),U=(u,A)=>{var r;if(!g.getFieldValue("storeId")){se.error("Please select a store first");return}const l=g.getFieldValue("saleInvoiceProduct"),c=I.find(n=>n.id===u);((r=c.stockInfo[0])==null?void 0:r.productQuantity)===0&&se.error("Product is out of stock");const a=l.map((n,N)=>{var p,j,w,v,x,m;return N===A?{...n,productQuantity:(p=c.stockInfo[0])!=null&&p.productQuantity?1:0,productSalePrice:(j=c.stockInfo[0])==null?void 0:j.productSalePrice,productVat:((w=c.productGroup.productSalesTax)==null?void 0:w.percentage)||0,productDiscount:(v=c.discount)!=null&&v.value?parseInt((x=c.discount)==null?void 0:x.value):0,discountType:((m=c.discount)==null?void 0:m.type)||"flat"}:n});g.setFieldsValue({saleInvoiceProduct:a}),f()},H=u=>{var n,N,p,j,w,v,x,m;const A=(N=(n=g.getFieldValue("saleInvoiceProduct"))==null?void 0:n.find((y,k)=>k===u))==null?void 0:N.productId,l=I==null?void 0:I.find(y=>A===y.id);let c=null;(p=l==null?void 0:l.stockInfo[0])!=null&&p.productQuantity&&(c=e.jsxs("span",{className:"text-xs",children:[e.jsx("span",{className:"mr-1",children:"Stock: "}),e.jsx("span",{children:l.stockInfo[0].productQuantity})]}));let a=null;l!=null&&l.productProductAttributeValue&&(a=l.productProductAttributeValue.map((y,k)=>{var Y,$,L;return e.jsxs("span",{className:"text-xs",children:[e.jsxs("span",{className:"mr-1",children:[($=(Y=y.productAttributeValue)==null?void 0:Y.productAttribute)==null?void 0:$.name,":"," "]}),e.jsx("span",{children:(L=y.productAttributeValue)==null?void 0:L.name}),k<l.productProductAttributeValue.length-1&&e.jsx("span",{children:", "})]},y.id)}));let r=null;return(w=(j=l==null?void 0:l.productGroup)==null?void 0:j.uom)!=null&&w.name&&(r=e.jsxs("span",{className:"text-xs",children:[e.jsx("span",{className:"mr-1",children:"UoM: "}),e.jsx("span",{children:`${(v=l==null?void 0:l.productGroup)==null?void 0:v.uomValue}/${(m=(x=l==null?void 0:l.productGroup)==null?void 0:x.uom)==null?void 0:m.name}`})]})),{stock:c,uom:r,attributes:a}};C.useEffect(()=>{_(xe())},[_]);const R=u=>{_(ie({page:1,count:1e3,storeId:u})),g.setFieldsValue({saleInvoiceProduct:[{}]})};return C.useEffect(()=>{B&&g.setFieldValue("storeId",B.id)},[B,g]),e.jsx(he,{className:"h-[calc(100vh-100px)]",headClass:"",bodyClass:"p-0",title:e.jsx("div",{className:"flex gap-2",children:e.jsx(Ie,{className:"w-[450px]",form:g,totalCalculator:f})}),extra:e.jsx(d.Item,{className:"mb-0 min-w-[200px]",name:"storeId",rules:[{required:!0,message:"Store is required"}],children:e.jsx(h,{className:"w-full",loading:b,showSearch:!0,onChange:R,placeholder:"Select a store",optionFilterProp:"children",children:F==null?void 0:F.map(u=>e.jsx(h.Option,{value:u.id,children:u.name},u.id))})}),children:e.jsx(d.List,{name:"saleInvoiceProduct",rules:[{required:!0,message:"Product is required"}],children:(u,{add:A,remove:l})=>e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"max-h-[calc(100vh-220px)] overflow-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"font-Popins text-black bg-tableHeaderBg border-gray-200 sticky top-0 z-10",children:e.jsxs("tr",{children:[e.jsx("th",{className:"py-2 pl-2 text-left",children:"SL"}),e.jsx("th",{className:"py-2 pl-2 text-left",children:"Product"}),e.jsx("th",{className:"py-2 pl-2 text-left",children:"Quantity"}),e.jsx("th",{className:"py-2 pl-2 text-left",children:"Price"}),e.jsx("th",{className:"py-2 pl-2 text-left",children:"Discount"}),e.jsx("th",{className:"py-2 pl-2 text-left",children:"Amount"}),e.jsx("th",{className:"py-2 pl-2 text-left",children:"Tax%"}),e.jsx("th",{className:"py-2 pl-2 text-left"})]})}),e.jsx("tbody",{className:"bg-tableBg",children:u.map(({key:c,name:a,...r},n)=>{var p,j,w,v;const N=H(n);return e.jsxs("tr",{className:`hover:bg-slate-900/10 py-1 ${n===u.length-1?"":"border-b"}`,children:[e.jsx("td",{className:"py-2 pl-2  align-top",children:n+1}),e.jsxs("td",{className:"py-2 pl-2 align-top",children:[e.jsx(d.Item,{...r,name:[a,"productId"],className:"mb-0 max-w-[250px]",rules:[{required:!0,message:"Product is required"}],children:e.jsx(h,{placeholder:"Select Product",showSearch:!0,loading:O,optionFilterProp:"children",filterOption:(x,m)=>m.children.toLowerCase().includes(x.toLowerCase()),onChange:x=>{U(x,n)},children:I==null?void 0:I.map(x=>e.jsx(h.Option,{value:x.id,children:x.name},x.id))})}),e.jsx("div",{className:"px-2",children:N.attributes}),e.jsx("div",{className:"px-2",children:N.uom})]}),e.jsxs("td",{className:"py-2 pl-2 align-top",children:[e.jsx(d.Item,{...r,name:[a,"productQuantity"],className:"mb-0 max-w-[100px]",rules:[{required:!0,message:"quantity is required"}],children:e.jsx(M,{type:"number",style:{width:"100%"},size:"small",placeholder:"Quantity",onChange:()=>f(n)})}),e.jsx("div",{children:N.stock})]}),e.jsx("td",{className:"py-2 pl-2 align-top",children:e.jsx(d.Item,{...r,name:[a,"productSalePrice"],className:"mb-0 max-w-[150px]",rules:[{required:!0,message:"Price is required"}],children:e.jsx(M,{type:"number",size:"small",style:{width:"100%"},placeholder:"50000",onChange:()=>f(n)})})}),e.jsx("td",{className:"py-2 pl-2 align-top",children:e.jsx("div",{className:"flex items-center",children:e.jsx(d.Item,{...r,name:[a,"productDiscount"],className:"mb-0 max-w-[150px]",rules:[{required:!0,message:"Discount is required"}],children:e.jsx(M,{type:"number",className:"discountType",addonAfter:e.jsx(d.Item,{...r,name:[a,"discountType"],noStyle:!0,children:e.jsxs(h,{size:"small",style:{width:50},defaultValue:"flat",popupClassName:"bg-white",onChange:()=>f(n),children:[e.jsx(h.Option,{children:e.jsx("span",{dangerouslySetInnerHTML:{__html:T==null?void 0:T.currencySymbol}})},"flat"),e.jsx(h.Option,{children:"%"},"percentage")]})}),placeholder:"0",style:{width:"100%"},size:"small",onChange:()=>f(n)})})})}),e.jsx("td",{className:"py-2 pl-2 align-top min-w-[80px]",children:e.jsx("div",{className:"font-weight-bold md:text-base xxs:text-xs",children:((j=(p=S[n])==null?void 0:p.subPrice)==null?void 0:j.toFixed(2))||0})}),e.jsxs("td",{className:"py-2 pl-2 align-top min-w-[80px]",children:[e.jsx(d.Item,{...r,name:[a,"productVat"],className:"mb-0 max-w-[100px]",rules:[{required:!0,message:"Tax is required"}],children:e.jsx(M,{type:"number",size:"small",style:{width:"100%"},placeholder:"50000",onChange:()=>f(n)})}),e.jsxs("div",{className:"text-xs",children:["Total:"," ",((v=(w=S[n])==null?void 0:w.subVatAmount)==null?void 0:v.toFixed(2))||0]})]}),e.jsx("td",{className:"py-2 pl-2 align-top",children:e.jsx(d.Item,{children:e.jsx("button",{shape:"circle",className:"flex justify-center items-center hover:bg-black/40 rounded-md",onClick:()=>{l(a),f(n)},children:e.jsx(ue,{size:25})})})})]},c)})})]})}),u.length===0&&e.jsx("div",{className:"text-center py-10",children:"No product selected yet"}),e.jsx("div",{className:"flex items-center justify-center mt-2",children:e.jsx(je,{onClick:()=>A(),className:"flex items-center justify-center w-48",block:!0,icon:e.jsx(Se,{}),children:"Add Product"})})]})})})}const le=Number(localStorage.getItem("id")),Ye=()=>{const{Option:g}=h,{isSaleCommission:I,currency:O}=ye(["isSaleCommission","currency"]),[f,S]=C.useState(!1),[T,_]=C.useState([]),[F,b]=C.useState(0),[B,U]=C.useState(0),[H,R]=C.useState(),[u,A]=C.useState(),l=me(),c=ne(),[a]=d.useForm(),r=E(s=>s.customers.list),{list:n,loading:N}=E(s=>s.products),p=E(s=>s.users.list),{list:j,loading:w}=E(s=>s.termsAndConditions),v=async s=>{try{const t=s.saleInvoiceProduct.reduce((i,D)=>{const q=D.productId;return i[q]?i[q].productQuantity+=D.productQuantity:i[q]={...D},i},{}),K=Object.values(t).map(i=>{const D=(i==null?void 0:i.productQuantity)||0,q=(i==null?void 0:i.productSalePrice)||0,Q={productId:i.productId,productQuantity:i.productQuantity,productUnitSalePrice:i.productSalePrice,tax:i.productVat};return Q.productDiscount=i.productDiscount,i.discountType==="percentage"&&(Q.productDiscount=q*D*(i==null?void 0:i.productDiscount)/100),Q}),W={...s,saleInvoiceProduct:K,paidAmount:s.paidAmount||[],saleCommission:F||null},z=await c(ve(W));z.payload.message==="success"?(a.resetFields(),S(!1),l(`/admin/sale/${z.payload.data.id}`)):S(!1),S(!1)}catch{S(!1)}},x=()=>{const s=a.getFieldValue("saleInvoiceProduct"),t=(s==null?void 0:s.reduce((V,o)=>{const J=(o==null?void 0:o.productQuantity)||0,Z=(o==null?void 0:o.productSalePrice)||0;let G=(o==null?void 0:o.productDiscount)||0;(o==null?void 0:o.discountType)==="percentage"&&(G=Z*J*G/100);const re=(o==null?void 0:o.productVat)||0,ee=Z*J-G,de=re/100*ee;return[...V,{subDiscount:G,subVatAmount:de,subPrice:ee}]},[]))||[];_(t);const P=t.reduce((V,o)=>V+o.subPrice,0),K=t.reduce((V,o)=>V+o.subVatAmount,0),W=P+K,z=a.getFieldValue("paidAmount")||[],i=z==null?void 0:z.reduce((V,o)=>V+(o.amount?Number(o.amount):0),0),D=W-i;U(D);const q=a.getFieldValue("commissionType"),Q=a.getFieldValue("saleCommission");if(q==="percentage"){const V=P*parseInt(Q)/100;b(V)}else b(Q)},m=r==null?void 0:r.find(s=>s.id===H),y=T.reduce((s,t)=>s+t.subPrice,0),k=T.reduce((s,t)=>s+t.subVatAmount,0),Y=T.reduce((s,t)=>s+t.subDiscount,0),$=y+k,L=s=>{const t=p.find(P=>P.id===s);if(a.setFieldsValue({commissionType:(t==null?void 0:t.commissionType)||"flat",saleCommission:t==null?void 0:t.commissionValue}),t.commissionType==="percentage"){const P=y*Number(t.commissionValue)/100;b(P)}else b(t.commissionValue)},oe=s=>{if(a.getFieldValue("commissionType")==="percentage"){const P=y*s/100;b(P)}else b(s)},ce=s=>{if(s==="percentage"){const t=y*a.getFieldValue("saleCommission")/100;b(t)}else b(a.getFieldValue("saleCommission"))};return C.useEffect(()=>{c(ge({status:"true",page:1,count:1e3})),c(fe({page:1,count:100})),c(ie({page:1,count:100,status:"true"})),c(be()),c(Ne()),c(we())},[c]),C.useEffect(()=>{const s=p==null?void 0:p.find(t=>t.id===le);a.setFieldsValue({commissionType:(s==null?void 0:s.commissionType)||"flat",saleCommission:s==null?void 0:s.commissionValue})},[p,a]),e.jsx(d,{form:a,name:"dynamic_form_nest_item",onFinish:v,onFinishFailed:()=>{S(!1)},layout:"vertical",size:"large",onKeyDown:s=>{s.key==="Enter"&&s.preventDefault()},autoComplete:"off",initialValues:{discount:0,date:pe(),vatId:[],saleInvoiceProduct:[{}],paymentType:1},children:e.jsxs("div",{className:"flex gap-2 2xl:h-[calc(100vh-100px)] min-h-[500px]",children:[e.jsx("div",{className:"w-[70%] 2xl:w-[75%]",children:e.jsx(Fe,{form:a,totalCalculator:x,subTotal:T,productList:n,productLoading:N})}),e.jsxs("div",{className:"flex flex-col w-[30%] 2xl:w-[25%] 2xl:h-[calc(100vh-80px)]",children:[e.jsxs("div",{className:"flex-grow 2xl:overflow-y-auto 2xl:overflow-x-hidden  pl-2",children:[e.jsx(d.Item,{label:e.jsxs(e.Fragment,{children:["Customer",e.jsx(ae,{title:"new Customer",children:e.jsx(Pe,{drawer:!0})})]}),className:"w-full mb-0",name:"customerId",rules:[{required:!0,message:"Please Select a Customer!"}],initialValue:1,children:e.jsx(h,{className:"w-full",loading:!r,showSearch:!0,onChange:s=>R(s),placeholder:"Select a customer ",optionFilterProp:"children",filterOption:(s,t)=>t.children.toLowerCase().includes(s.toLowerCase()),children:r&&(r==null?void 0:r.map(s=>e.jsx(g,{value:s.id,children:s.username},s.id)))})}),((m==null?void 0:m.address)||(m==null?void 0:m.phone))&&e.jsxs("div",{className:"flex justify-between py-1 px-4",children:[e.jsxs("span",{children:[e.jsx("span",{children:"Address: "}),e.jsx("span",{children:m==null?void 0:m.address})," "]}),e.jsxs("span",{children:[e.jsx("span",{children:"Phone: "}),e.jsx("span",{children:m==null?void 0:m.phone})," "]})]}),e.jsx(d.Item,{label:"Date",required:!0,className:"w-full mb-0",name:"date",rules:[{required:!0,message:"Please input Date!"}],children:e.jsx(te,{label:"date",size:"small",format:"YYYY-MM-DD"})}),e.jsx(d.Item,{label:"Due date",className:"w-full mb-0",name:"dueDate",children:e.jsx(te,{label:"date",size:"small",format:"YYYY-MM-DD"})}),e.jsx(d.Item,{className:"w-full mb-0",label:"Sales Person",name:"userId",initialValue:le,required:!0,children:e.jsx(h,{className:"w-full",loading:!p,showSearch:!0,placeholder:"Select sales person ",optionFilterProp:"children",onChange:L,filterOption:(s,t)=>t.children.toLowerCase().includes(s.toLowerCase()),children:p&&(p==null?void 0:p.map(s=>e.jsx(g,{value:s.id,children:s.username},s.id)))})}),I==="true"&&e.jsxs(e.Fragment,{children:[e.jsx(d.Item,{name:"saleCommission",className:"mb-0 max-w-full",label:"Sale Commission",children:e.jsx(M,{className:"discountType",addonAfter:e.jsx(d.Item,{name:"commissionType",noStyle:!0,children:e.jsxs(h,{size:"small",style:{width:50},defaultValue:"flat",popupClassName:"bg-white",onChange:ce,children:[e.jsx(h.Option,{children:e.jsx("span",{dangerouslySetInnerHTML:{__html:O==null?void 0:O.currencySymbol}})},"flat"),e.jsx(h.Option,{children:"%"},"percentage")]})}),placeholder:"0",style:{width:"100%"},size:"small",onChange:oe})}),e.jsx("div",{className:"flex items-center justify-between p-1 text-gray-600 duration-200",children:e.jsxs("span",{children:["Total:"," ",F?Number(F).toFixed(2):0]})})]}),e.jsx(d.Item,{className:"mb-0",label:"Shipping Address",name:"address",children:e.jsx(X,{className:"",placeholder:"Enter shipping address",size:"small"})}),e.jsx(d.Item,{className:"mb-0",label:"Note",name:"note",children:e.jsx(X,{className:"",size:"small",placeholder:"Write sale Note",label:"note"})}),e.jsx(d.Item,{className:"mb-0",label:e.jsxs(e.Fragment,{children:["Terms and conditions",u&&e.jsx("button",{onClick:()=>A(!1),className:"py-1 px-2 bg-red-200 rounded ml-1 text-gray-500",children:"Cancel"}),e.jsx(ae,{title:"New Terms and conditions",children:e.jsx(Ve,{drawer:!0})})]}),name:"termsAndConditions",children:u?e.jsx(X.TextArea,{onChange:s=>A(s),value:u}):e.jsx(h,{className:"w-full",loading:w,showSearch:!0,value:u,placeholder:"Select Terms and conditions",onSelect:s=>A(s),children:j&&(j==null?void 0:j.map(s=>e.jsx(g,{value:s.subject,children:s.title},s.id)))})})]}),e.jsxs("div",{className:"bg-gray-100 px-2",children:[e.jsxs("div",{className:"py-2",children:[e.jsxs("div",{className:" flex justify-between",children:[e.jsx("strong",{children:"Total amount: "}),e.jsxs("strong",{children:[Number(y).toFixed(2)," "]})]}),e.jsxs("div",{className:" flex justify-between",children:[e.jsx("span",{children:"Total discount: "}),e.jsxs("span",{children:[Number(Y).toFixed(2)," "]})]}),e.jsxs("div",{className:"py-1 flex justify-between items-center mb-1",children:[e.jsx("span",{children:"Total tax amount: "}),e.jsx("span",{children:Number(k).toFixed(2)})]}),e.jsxs("div",{className:"py-1 flex justify-between items-center mb-1",children:[e.jsx("strong",{children:"Total Payable: "}),e.jsx("strong",{children:Number($).toFixed(2)})]}),e.jsxs("div",{className:"py-1 mb-1 flex justify-between",children:[e.jsx("strong",{children:"Due Amount:"}),e.jsx("strong",{children:B.toFixed(2)})]}),e.jsxs("div",{className:"flex justify-between mb-2",children:[e.jsx("span",{className:"",children:"Paid Amount: "}),e.jsx("div",{className:"w-[65%] flex items-center justify-between gap-2",children:e.jsx(Te,{totalCalculator:x})})]})]}),e.jsx("div",{className:"flex gap-2",children:e.jsx(d.Item,{className:"w-full pb-0",children:e.jsx(Ae,{block:!0,type:"primary",htmlType:"submit",loading:f,onClick:()=>S(!0),children:"Create Sale"})})})]})]})]})})};export{Ye as default};
