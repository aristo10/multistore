import{cL as E,cM as A,r as k,cN as e,d9 as _,cV as z,c_ as $,cO as M}from"./vendor-3a94a37a.js";import{al as Y,C as G,aX as R,aP as O,ak as U,co as H}from"./index-ed7845ca.js";import{S as K}from"./Search-32fc9847.js";import{F as m,b as g,h as B,P as W,D as X,I as J,B as Z}from"./vendor-large-f75deccb.js";function L({form:p,productList:n,productLoading:v,totalCalculator:f,subTotal:w}){const x=E(),{list:h,loading:P,defaultStore:N}=A(c=>c.store),b=(c,j)=>{var l;if(!p.getFieldValue("storeIdFrom")){z.error("Please select a store first");return}const s=p.getFieldValue("stockInfo"),o=n.find(a=>a.id===c);((l=o.stockInfo[0])==null?void 0:l.productQuantity)===0&&z.error("Product is out of stock");const d=s.map((a,u)=>{var t,i,r;return u===j?{...a,stockIdFrom:(t=o.stockInfo[0])==null?void 0:t.id,productQuantity:(i=o.stockInfo[0])!=null&&i.productQuantity?1:0,productPurchasePrice:(r=o.stockInfo[0])==null?void 0:r.productPurchasePrice}:a});p.setFieldsValue({stockInfo:d}),f()},S=c=>{var a,u,t,i,r,I,V,C;const j=(u=(a=p.getFieldValue("stockInfo"))==null?void 0:a.find((y,q)=>q===c))==null?void 0:u.productId,s=n==null?void 0:n.find(y=>j===y.id);let o=null;(t=s==null?void 0:s.stockInfo[0])!=null&&t.productQuantity&&(o=e.jsxs("span",{className:"text-xs",children:[e.jsx("span",{className:"mr-1",children:"Stock: "}),e.jsx("span",{children:s.stockInfo[0].productQuantity})]}));let d=null;s!=null&&s.productProductAttributeValue&&(d=s.productProductAttributeValue.map((y,q)=>{var Q,T,D;return e.jsxs("span",{className:"text-xs",children:[e.jsxs("span",{className:"mr-1",children:[(T=(Q=y.productAttributeValue)==null?void 0:Q.productAttribute)==null?void 0:T.name,":"," "]}),e.jsx("span",{children:(D=y.productAttributeValue)==null?void 0:D.name}),q<s.productProductAttributeValue.length-1&&e.jsx("span",{children:", "})]},y.id)}));let l=null;return(r=(i=s==null?void 0:s.productGroup)==null?void 0:i.uom)!=null&&r.name&&(l=e.jsxs("span",{className:"text-xs",children:[e.jsx("span",{className:"mr-1",children:"UoM: "}),e.jsx("span",{children:`${(I=s==null?void 0:s.productGroup)==null?void 0:I.uomValue}/${(C=(V=s==null?void 0:s.productGroup)==null?void 0:V.uom)==null?void 0:C.name}`})]})),{stock:o,uom:l,attributes:d}};k.useEffect(()=>{x(Y())},[x]);const F=c=>{x(O({page:1,count:1e3,storeId:c})),p.setFieldsValue({stockInfo:[{}]})};return k.useEffect(()=>{N&&p.setFieldValue("storeIdFrom",N.id)},[N,p]),e.jsx(G,{className:"h-[calc(100vh-120px)]",headClass:"",bodyClass:"p-0",title:e.jsx("div",{className:"flex gap-2",children:e.jsx(K,{className:"w-[450px]",form:p,totalCalculator:f})}),extra:e.jsx(m.Item,{className:"mb-0 min-w-[200px]",name:"storeIdFrom",rules:[{required:!0,message:"Store is required"}],children:e.jsx(g,{className:"w-full",loading:P,showSearch:!0,onChange:F,placeholder:"Select a store",optionFilterProp:"children",children:h==null?void 0:h.map(c=>e.jsx(g.Option,{value:c.id,children:c.name},c.id))})}),children:e.jsx(m.List,{name:"stockInfo",rules:[{required:!0,message:"Product is required"}],children:(c,{add:j,remove:s})=>e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"max-h-[calc(100vh-220px)] overflow-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"font-Popins text-black bg-tableHeaderBg border-gray-200 sticky top-0 z-10",children:e.jsxs("tr",{children:[e.jsx("th",{className:"py-2 pl-2 text-left",children:"SL"}),e.jsx("th",{className:"py-2 pl-2 text-left",children:"Product"}),e.jsx("th",{className:"py-2 pl-2 text-left",children:"Price"}),e.jsx("th",{className:"py-2 pl-2 text-left",children:"Quantity"}),e.jsx("th",{className:"py-2 pl-2 text-left",children:"Amount"}),e.jsx("th",{className:"py-2 pl-2 text-left"})]})}),e.jsx("tbody",{className:"bg-tableBg",children:c.map(({key:o,name:d,...l},a)=>{var t,i;const u=S(a);return e.jsxs("tr",{className:`hover:bg-slate-900/10 py-1 ${a===c.length-1?"":"border-b"}`,children:[e.jsx("td",{className:"py-2 pl-2  align-top",children:a+1}),e.jsxs("td",{className:"py-2 pl-2 align-top",children:[e.jsx(m.Item,{...l,name:[d,"productId"],className:"mb-0 max-w-[500px]",rules:[{required:!0,message:"Product is required"}],children:e.jsx(g,{placeholder:"Select Product",showSearch:!0,loading:v,optionFilterProp:"children",filterOption:(r,I)=>I.children.toLowerCase().includes(r.toLowerCase()),onChange:r=>{b(r,a)},children:n==null?void 0:n.map(r=>e.jsx(g.Option,{value:r.id,children:r.name},r.id))})}),e.jsx("div",{className:"px-2",children:u.attributes}),e.jsx("div",{className:"px-2",children:u.uom})]}),e.jsx("td",{className:"py-2 pl-2 align-top",children:e.jsx(m.Item,{...l,name:[d,"productPurchasePrice"],className:"mb-0 max-w-[150px]",rules:[{required:!0,message:"Price is required"}],children:e.jsx(B,{type:"number",size:"small",style:{width:"100%"},placeholder:"50000",disabled:!0})})}),e.jsxs("td",{className:"py-2 pl-2 align-top",children:[e.jsx(m.Item,{...l,name:[d,"productQuantity"],className:"mb-0 max-w-[200px]",rules:[{required:!0,message:"quantity is required"}],children:e.jsx(B,{type:"number",style:{width:"100%"},size:"small",placeholder:"Quantity",onChange:()=>f(a)})}),e.jsx("div",{children:u.stock})]}),e.jsx("td",{className:"py-2 pl-2 align-top min-w-[80px]",children:e.jsx("div",{className:"font-weight-bold md:text-base xxs:text-xs",children:((i=(t=w[a])==null?void 0:t.subPrice)==null?void 0:i.toFixed(2))||0})}),e.jsx("td",{className:"py-2 pl-2 align-top",children:e.jsx(m.Item,{children:e.jsx("button",{shape:"circle",className:"flex justify-center items-center hover:bg-black/40 rounded-md",onClick:()=>{s(d),f(a)},children:e.jsx(_,{size:25})})})})]},o)})})]})}),c.length===0&&e.jsx("div",{className:"text-center py-10",children:"No product selected yet"}),e.jsx("div",{className:"flex items-center justify-center mt-2",children:e.jsx(R,{onClick:()=>j(),className:"flex items-center justify-center w-48",block:!0,icon:e.jsx(W,{}),children:"Add Product"})})]})})})}function le(){const[p,n]=k.useState(!1),[v,f]=k.useState([]),w=$(),x=E(),[h]=m.useForm(),{list:P,loading:N}=A(s=>s.products),{allList:b,loading:S}=A(s=>s.store),F=async s=>{try{const o=s.stockInfo.reduce((t,i)=>{const r=i.productId;return t[r]?t[r].productQuantity+=i.productQuantity:t[r]={...i},t},{}),l=Object.values(o).map(t=>{const i=(t==null?void 0:t.productQuantity)||0;return{stockIdFrom:t.stockIdFrom,quantity:i}}),a={...s,stockInfo:l},u=await x(H(a));u.payload.message==="success"?(h.resetFields(),n(!1),w(`/admin/stock-transfer/${u.payload.data.id}`)):n(!1),n(!1)}catch{n(!1)}},c=()=>{const s=h.getFieldValue("stockInfo"),o=(s==null?void 0:s.reduce((d,l)=>{const a=(l==null?void 0:l.productQuantity)||0,t=((l==null?void 0:l.productPurchasePrice)||0)*a;return[...d,{subPrice:t}]},[]))||[];f(o)},j=v.reduce((s,o)=>s+o.subPrice,0);return k.useEffect(()=>{x(O({page:1,count:100,status:"true"})),x(U())},[x]),e.jsx(m,{form:h,name:"dynamic_form_nest_item",onFinish:F,onFinishFailed:()=>{n(!1)},layout:"vertical",size:"large",onKeyDown:s=>{s.key==="Enter"&&s.preventDefault()},autoComplete:"off",initialValues:{date:M(),stockInfo:[{}]},children:e.jsxs("div",{className:"flex gap-2 2xl:h-[calc(100vh-130px)] min-h-[500px]",children:[e.jsx("div",{className:"w-[70%] 2xl:w-[75%]",children:e.jsx(L,{form:h,totalCalculator:c,subTotal:v,productList:P,productLoading:N})}),e.jsxs("div",{className:"flex flex-col w-[30%] 2xl:w-[25%] 2xl:h-[calc(100vh-120px)]",children:[e.jsxs("div",{className:"flex-grow 2xl:overflow-y-auto 2xl:overflow-x-hidden  pl-2",children:[e.jsx(m.Item,{label:"Transfer to",className:"mb-0 min-w-[200px]",name:"storeIdTo",rules:[{required:!0,message:"Store is required"}],children:e.jsx(g,{className:"w-full",loading:S,showSearch:!0,placeholder:"Select a store",optionFilterProp:"children",children:b==null?void 0:b.map(s=>e.jsx(g.Option,{value:s.id,children:s.name},s.id))})}),e.jsx(m.Item,{label:"Date",required:!0,className:"w-full mb-0",name:"date",rules:[{required:!0,message:"Please input Date!"}],children:e.jsx(X,{label:"date",size:"small",format:"YYYY-MM-DD"})}),e.jsx(m.Item,{className:"mb-0",label:"Note",name:"note",children:e.jsx(J,{className:"",size:"small",placeholder:"Write sale Note",label:"note"})})]}),e.jsxs("div",{className:"bg-gray-100 px-2",children:[e.jsx("div",{className:"py-2",children:e.jsxs("div",{className:" flex justify-between",children:[e.jsx("strong",{children:"Total amount: "}),e.jsxs("strong",{children:[Number(j).toFixed(2)," "]})]})}),e.jsx("div",{className:"flex gap-2",children:e.jsx(m.Item,{className:"w-full pb-0",children:e.jsx(Z,{block:!0,type:"primary",htmlType:"submit",loading:p,onClick:()=>n(!0),children:"Create Stock Transfer"})})})]})]})]})})}export{le as default};
