import{cL as U,r as I,cM as T,cN as e,cY as K,cZ as L,d9 as X,c_ as Z,cO as J}from"./vendor-3a94a37a.js";import{af as W,ag as $,C as ee,aX as se,aU as te,aP as ae,al as le,fQ as re}from"./index-ed7845ca.js";import{F as x,b as Q,h as D,P as ce,D as ne,I as G,B as ie}from"./vendor-large-f75deccb.js";import{B as de}from"./BigDrawer-240149a9.js";import{A as oe}from"./AddSupplier-afdd8a94.js";import{P as ue}from"./Payments-cf7d9c72.js";import"./UploadMany-c4472299.js";function pe({form:j,totalCalculator:y}){const f=U(),[c,w]=I.useState(""),A=I.useRef(null),{list:b}=T(t=>t.productSearch),N=t=>{var r,d,u;const l=j.getFieldValue("purchaseInvoiceProduct")||[];if(l.find(i=>i.productId===t.id)){const i=l.map(o=>t.id===o.productId?{...o,productQuantity:o.productQuantity?o.productQuantity+1:1}:t);j.setFieldsValue({purchaseInvoiceProduct:i})}else j.setFieldsValue({purchaseInvoiceProduct:[...l,{productId:t.id,productQuantity:0,productSalePrice:(r=t.stockInfo[0])==null?void 0:r.productSalePrice,productPurchasePrice:(d=t.stockInfo[0])==null?void 0:d.productPurchasePrice,tax:((u=t.productGroup.productPurchaseTax)==null?void 0:u.percentage)||0}]});y()},S=async t=>{A.current&&clearTimeout(A.current),w(t.target.value),A.current=setTimeout(async()=>{var l,n,r,d,u;if(t.target.value!==""){const i=await f(W({query:"search",key:t.target.value,count:7}));((r=(n=(l=i.payload)==null?void 0:l.data)==null?void 0:n.getAllProduct)==null?void 0:r.length)===1&&(N((u=(d=i.payload)==null?void 0:d.data)==null?void 0:u.getAllProduct[0]),a())}else f($())},500)},a=()=>{c!==""&&(w(""),f($()))};return I.useEffect(()=>()=>{a()},[]),e.jsxs("div",{className:"relative w-[450px]",children:[e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"text",value:c,onChange:S,className:`w-full py-2 px-5 rounded-lg outline-0 ${(b==null?void 0:b.length)>0&&"rounded-b-none"}`,placeholder:"Search Product"}),c&&e.jsx("button",{type:"button",onClick:a,className:"text-black/50 absolute  right-8 h-full pl-2 pr-4 z-10 ",children:e.jsx(K,{size:25})}),e.jsx("button",{type:"submit",className:"text-gray-400 absolute  right-0 h-full pl-2 pr-4 z-10 ",children:e.jsx(L,{size:25})})]}),(b==null?void 0:b.length)>0&&e.jsx("div",{className:"absolute bg-white shadow-md z-20 w-full rounded-b-lg max-h-80 md:max-h-[600px] overflow-y-auto ",children:b.map(t=>e.jsx(me,{onSelect:N,product:t,handleClear:a},t.id))})]})}function me({product:j,onSelect:y,handleClear:f}){const{name:c,productQuantity:w}=j;return e.jsxs("div",{onClick:()=>{y(j),f()},className:"flex justify-between items-center gap-2 py-1 w-full px-5 hover:bg-slate-950/10 text-sm",children:[e.jsx("div",{className:"flex items-center gap-3 justify-start",children:e.jsx("h1",{className:"font-medium text-gray-700",children:c})}),e.jsx("div",{className:"",children:w>0?e.jsxs("span",{className:"bg-green-500/10 text-green-700 rounded px-2 flex gap-2",children:["Stock: ",e.jsx("span",{children:w})]}):e.jsx("span",{className:"bg-red-500/10 text-red-700 rounded px-2",children:"Stock out"})})]})}function he({form:j,productList:y,productLoading:f,totalCalculator:c,subTotal:w}){const A=(N,S)=>{const a=j.getFieldValue("purchaseInvoiceProduct"),t=y.find(n=>n.id===N),l=a.map((n,r)=>{var d,u,i;return r===S?{...n,productQuantity:t.productQuantity?1:0,productSalePrice:((d=t.stockInfo[0])==null?void 0:d.productSalePrice)||0,productPurchasePrice:((u=t.stockInfo[0])==null?void 0:u.productPurchasePrice)||0,tax:((i=t.productGroup.productPurchaseTax)==null?void 0:i.percentage)||0}:n});j.setFieldsValue({purchaseInvoiceProduct:l}),c(S)},b=N=>{var n,r,d,u,i,o,F;const S=(r=(n=j.getFieldValue("purchaseInvoiceProduct"))==null?void 0:n.find((h,P)=>P===N))==null?void 0:r.productId,a=y==null?void 0:y.find(h=>S===h.id);let t=null;a!=null&&a.productProductAttributeValue&&(t=a.productProductAttributeValue.map((h,P)=>{var V,q,z;return e.jsxs("span",{className:"text-xs",children:[e.jsxs("span",{className:"mr-1",children:[(q=(V=h.productAttributeValue)==null?void 0:V.productAttribute)==null?void 0:q.name,":"," "]}),e.jsx("span",{children:(z=h.productAttributeValue)==null?void 0:z.name}),P<a.productProductAttributeValue.length-1&&e.jsx("span",{children:", "})]},h.id)}));let l=null;return(u=(d=a==null?void 0:a.productGroup)==null?void 0:d.uom)!=null&&u.name&&(l=e.jsxs("span",{className:"text-xs",children:[e.jsx("span",{className:"mr-1",children:"UoM: "}),e.jsx("span",{children:`${(i=a==null?void 0:a.productGroup)==null?void 0:i.uomValue}/${(F=(o=a==null?void 0:a.productGroup)==null?void 0:o.uom)==null?void 0:F.name}`})]})),{uom:l,attributes:t}};return e.jsx(ee,{className:"h-[calc(100vh-100px)]",headClass:"",bodyClass:"p-0",title:e.jsx(e.Fragment,{children:e.jsx(pe,{form:j,totalCalculator:c,isPurchase:!0})}),children:e.jsx(x.List,{name:"purchaseInvoiceProduct",rules:[{required:!0,message:"Product is required"}],children:(N,{add:S,remove:a})=>e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"max-h-[calc(100vh-220px)] overflow-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"font-Popins text-black bg-tableHeaderBg border-gray-200 sticky top-0 z-10",children:e.jsxs("tr",{children:[e.jsx("th",{className:"py-2 pl-2 text-left",children:"SL"}),e.jsx("th",{className:"py-2 pl-2 text-left",children:"Product"}),e.jsx("th",{className:"py-2 pl-2 text-left",children:"Quantity"}),e.jsx("th",{className:"py-2 pl-2 text-left",children:"Purchase price"}),e.jsx("th",{className:"py-2 pl-2 text-left",children:"Selling price"}),e.jsx("th",{className:"py-2 pl-2 text-left",children:"Amount"}),e.jsx("th",{className:"py-2 pl-2 text-left",children:"Tax%"}),e.jsx("th",{className:"py-2 pl-2 text-left"})]})}),e.jsx("tbody",{className:"bg-tableBg",children:N.map(({key:t,name:l,...n},r)=>{var u,i,o,F;const d=b(r);return e.jsxs("tr",{className:`hover:bg-slate-900/10 py-1 ${r===N.length-1?"":"border-b"}`,children:[e.jsx("td",{className:"py-2 pl-2 align-top",children:r+1}),e.jsxs("td",{className:"py-2 pl-2 align-top",children:[e.jsx(x.Item,{...n,className:"mb-0  max-w-[250px]",name:[l,"productId"],rules:[{required:!0,message:"Product is required"}],children:e.jsx(Q,{placeholder:"Select Product",showSearch:!0,loading:f,optionFilterProp:"children",onChange:h=>{A(h,r)},children:y==null?void 0:y.map(h=>e.jsx(Q.Option,{value:h.id,children:h.name},h.id))})}),e.jsx("div",{className:"px-2",children:d.attributes}),e.jsx("div",{className:"px-2",children:d.uom})]}),e.jsx("td",{className:"py-2 pl-2 align-top",children:e.jsx(x.Item,{...n,className:"mb-0 max-w-[100px]",name:[l,"productQuantity"],rules:[{required:!0,message:"quantity is required"}],children:e.jsx(D,{type:"number",size:"small",placeholder:"Quantity",onChange:()=>c(r)})})}),e.jsx("td",{className:"py-2 pl-2 align-top",children:e.jsx(x.Item,{...n,className:"mb-0 max-w-[150px]",name:[l,"productPurchasePrice"],rules:[{required:!0,message:"Price is required"}],children:e.jsx(D,{size:"small",type:"number",placeholder:"50000",onChange:()=>c(r)})})}),e.jsx("td",{className:"py-2 pl-2 align-top",children:e.jsx(x.Item,{...n,className:"mb-0 max-w-[150px]",name:[l,"productSalePrice"],rules:[{required:!0,message:"Price is required"}],children:e.jsx(D,{size:"small",type:"number",placeholder:"50000",onChange:()=>c(r)})})}),e.jsx("td",{className:"py-2 pl-2 align-top min-w-[80px]",children:e.jsx("div",{className:"font-weight-bold totalMargin",children:((i=(u=w[r])==null?void 0:u.subPrice)==null?void 0:i.toFixed(2))||0})}),e.jsxs("td",{className:"py-2 pl-2 align-top min-w-[80px]",children:[e.jsx(x.Item,{...n,name:[l,"tax"],initialValue:0,className:"mb-0 max-w-[100px]",rules:[{required:!0,message:"Tax is required"}],children:e.jsx(D,{size:"small",type:"number",style:{width:"100%"},onChange:()=>c(r)})}),e.jsxs("div",{className:"text-xs",children:["Total: ",((F=(o=w[r])==null?void 0:o.totalVat)==null?void 0:F.toFixed(2))||0]})]}),e.jsx("td",{className:"py-2 pl-2 align-top",children:e.jsx(x.Item,{children:e.jsx("button",{shape:"circle",className:"flex justify-center items-center hover:bg-black/40 rounded-md",onClick:()=>{a(l),c(r)},children:e.jsx(X,{size:25})})})})]},t)})})]})}),N.length===0&&e.jsx("div",{className:"text-center py-10",children:"No product selected yet"}),e.jsx("div",{className:"flex items-center justify-center mt-2",children:e.jsx(se,{onClick:()=>S(),className:"flex items-center justify-center w-48",block:!0,icon:e.jsx(ce,{}),children:"Add Product"})})]})})})}const Pe=()=>{const{Option:j}=Q,[y,f]=I.useState(!1),[c,w]=I.useState([]),[A,b]=I.useState(0),[N,S]=I.useState(),a=Z(),t=U();I.useEffect(()=>{t(te({status:!0,page:1,count:10})),t(ae({query:"all"})),t(le())},[t]);const l=T(s=>s.suppliers.list),{list:n,loading:r}=T(s=>s.products),{list:d,loading:u,defaultStore:i}=T(s=>s.store),[o]=x.useForm(),F=async s=>{try{const p=s.purchaseInvoiceProduct.reduce((g,C)=>{const v=C.productId;return g[v]?g[v].productQuantity+=C.productQuantity:g[v]={...C},g},{}),M=Object.values(p).map(g=>({...g,productId:g.productId,productQuantity:g.productQuantity,productUnitPurchasePrice:g.productPurchasePrice,productUnitSalePrice:g.productSalePrice,tax:g.tax})),B={...s,purchaseInvoiceProduct:M,paidAmount:s.paidAmount||[]},k=await t(re(B));k.payload.message==="success"?(o.resetFields(),f(!1),a(`/admin/purchase/${k.payload.data.id}`)):f(!1)}catch{f(!1)}},h=()=>{const s=o.getFieldValue("purchaseInvoiceProduct"),p=(s==null?void 0:s.reduce((v,m)=>{const Y=(m==null?void 0:m.productQuantity)||0,_=(m==null?void 0:m.productPurchasePrice)||0,R=(m==null?void 0:m.tax)||0,O=_*Y,H=R/100*O;return[...v,{subPrice:O,totalVat:H}]},[]))||[];w(p);const E=p==null?void 0:p.reduce((v,m)=>v+m.subPrice,0),M=p==null?void 0:p.reduce((v,m)=>v+m.totalVat,0),B=E+M,k=o.getFieldValue("paidAmount")||[],g=k==null?void 0:k.reduce((v,m)=>v+(m.amount?parseInt(m.amount):0),0),C=B-g;b(C)},P=l==null?void 0:l.find(s=>s.id===N),V=c==null?void 0:c.reduce((s,p)=>s+p.subPrice,0),q=c==null?void 0:c.reduce((s,p)=>s+p.totalVat,0),z=V+q;return I.useEffect(()=>{i&&o.setFieldValue("storeId",i.id)},[i,o]),e.jsx(x,{form:o,className:"w-full ",name:"dynamic_form_nest_item",onFinish:F,onFinishFailed:()=>{f(!1)},layout:"vertical",size:"large",onKeyDown:s=>{s.key==="Enter"&&s.preventDefault()},initialValues:{paidAmount:0,discount:0,date:J(),purchaseInvoiceProduct:[{}]},children:e.jsxs("div",{className:"flex gap-4 2xl:h-[calc(100vh-100px)] min-h-[500px]",children:[e.jsx("div",{className:"w-[70%] 2xl:w-[75%]",children:e.jsx(he,{totalCalculator:h,subTotal:c,form:o,productList:n,productLoading:r})}),e.jsxs("div",{className:"flex flex-col w-[30%] 2xl:w-[25%]",children:[e.jsxs("div",{className:"flex-grow",children:[e.jsxs("div",{className:"w-full",children:[e.jsx(x.Item,{label:e.jsxs(e.Fragment,{children:["Supplier"," ",e.jsx(de,{className:"",title:"Add New Supplier",children:e.jsx(oe,{drawer:!0})})]}),name:"supplierId",className:"w-full mb-0",rules:[{required:!0,message:"Please Select a supplier!"}],children:e.jsx(Q,{className:"w-full",loading:!l,onChange:s=>S(s),showSearch:!0,placeholder:"Select a supplier ",optionFilterProp:"children",filterOption:(s,p)=>p.children.toLowerCase().includes(s.toLowerCase()),children:l&&l.map(s=>e.jsx(j,{value:s.id,children:s.name},s.id))})}),P&&e.jsxs("div",{className:"flex justify-between py-1 px-4",children:[e.jsxs("span",{children:[e.jsx("span",{children:"Address: "}),e.jsx("span",{children:P==null?void 0:P.address})," "]}),e.jsxs("span",{children:[e.jsx("span",{children:"Phone: "}),e.jsx("span",{children:P==null?void 0:P.phone})," "]})]})]}),e.jsx(x.Item,{label:"Store",name:"storeId",className:"w-full mb-0",rules:[{required:!0,message:"Please Select a store!"}],children:e.jsx(Q,{className:"w-full",loading:u,showSearch:!0,placeholder:"Select a store",optionFilterProp:"children",children:d==null?void 0:d.map(s=>e.jsx(j,{value:s.id,children:s.name},s.id))})}),e.jsx(x.Item,{name:"date",label:"Date",className:"w-full mb-0",layout:"horizental",required:!0,rules:[{required:!0,message:"Please input Date!"}],children:e.jsx(ne,{size:"small",format:"YYYY-MM-DD",className:"date-picker"})}),e.jsx(x.Item,{className:"w-full mb-0",name:"supplierMemoNo",label:"Supplier Memo",children:e.jsx(G,{className:"w-full",placeholder:"Memo no "})}),e.jsx(x.Item,{className:"w-full mb-0",name:"note",label:"Note",children:e.jsx(G,{className:"w-full",placeholder:"Note"})})]}),e.jsxs("div",{className:"py-2",children:[e.jsxs("div",{className:" flex justify-between",children:[e.jsx("strong",{children:"Total amount: "}),e.jsx("strong",{children:V.toFixed(2)})]}),e.jsxs("div",{className:"py-1 flex justify-between items-center",children:[e.jsx("span",{children:"Total tax amount: "}),e.jsx("span",{children:q.toFixed(2)})]}),e.jsxs("div",{className:"py-1 flex justify-between items-center",children:[e.jsx("strong",{children:"Total Payable: "}),e.jsx("strong",{children:z.toFixed(2)})]}),e.jsxs("div",{className:"py-1 mb-4 flex justify-between",children:[e.jsx("strong",{children:"Due Amount:"}),e.jsx("strong",{children:A.toFixed(2)})]}),e.jsxs("div",{className:"flex justify-between mb-2",children:[e.jsx("span",{className:"",children:"Paid Amount: "}),e.jsx("div",{className:"w-[65%] flex items-center justify-between gap-2",children:e.jsx(ue,{totalCalculator:h})})]}),e.jsx(x.Item,{style:{marginTop:"15px"},children:e.jsx(ie,{block:!0,type:"primary",htmlType:"submit",loading:y,onClick:()=>f(!0),children:"Create Purchase"})})]})]})]})})};export{Pe as default};
