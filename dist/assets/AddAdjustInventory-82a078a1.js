import{cL as Q,r as b,cM as k,cN as e,cY as $,cZ as E,d9 as Y,c_ as L,cO as M}from"./vendor-3a94a37a.js";import{ae as _,af as B,ag as q,C as R,aP as z,aj as H,eT as U}from"./index-ed7845ca.js";import{F as p,b as N,h as V,B as O,P as W,D as Z}from"./vendor-large-f75deccb.js";function G({className:c,form:i,totalCalculator:v,setSelectedProduct:h}){const f=Q(),[x,I]=b.useState(""),w=b.useRef(null),{list:o}=k(a=>a.productSearch),T=a=>{var l,u,d,t;const n=i.getFieldValue("adjustInvoiceProduct")||[];if(n.find(s=>s.productId===a.id)){const s=n.map(r=>a.id===r.productId?{...r,productQuantity:r.productQuantity?r.productQuantity+1:1}:a);i.setFieldsValue({adjustInvoiceProduct:s})}else h&&h(s=>[...s,a]),i.setFieldsValue({adjustInvoiceProduct:[...n,{productId:a.id,productName:a.name,productQuantity:h?1:0,productPurchasePrice:a.productPurchasePrice,productVat:a.productVat?(l=a.productVat)==null?void 0:l.percentage:0,productDiscount:(u=a.discount)!=null&&u.value?parseInt((d=a.discount)==null?void 0:d.value):0,discountType:((t=a.discount)==null?void 0:t.type)||"flat"}]});v()},C=async a=>{w.current&&clearTimeout(w.current),I(a.target.value),w.current=setTimeout(async()=>{var n,j,l,u,d;if(a.target.value!==""){const t=await f(B({query:"search",key:a.target.value,count:7}));((l=(j=(n=t.payload)==null?void 0:n.data)==null?void 0:j.getAllProduct)==null?void 0:l.length)===1&&(T((d=(u=t.payload)==null?void 0:u.data)==null?void 0:d.getAllProduct[0]),g())}else f(q())},500)},g=()=>{x!==""&&(I(""),f(q()))};return b.useEffect(()=>()=>{g()},[]),e.jsxs("div",{className:_("relative w-full ",{[c]:c}),children:[e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"text",value:x,onChange:C,className:`w-full py-2 px-5 rounded-lg outline-0 ${(o==null?void 0:o.length)>0&&"rounded-b-none"}`,placeholder:"Search Product"}),x&&e.jsx("button",{type:"button",onClick:g,className:"text-black/50 absolute  right-8 h-full pl-2 pr-4 z-10 ",children:e.jsx($,{size:25})}),e.jsx("button",{type:"button",className:"text-gray-400 absolute  right-0 h-full pl-2 pr-4 z-10 ",children:e.jsx(E,{size:25})})]}),(o==null?void 0:o.length)>0&&e.jsx("div",{className:"absolute bg-white shadow-md z-20 w-full rounded-b-lg max-h-80 md:max-h-[600px] overflow-y-auto ",children:o.map(a=>e.jsx(J,{onSelect:T,product:a,handleClear:g},a.id))})]})}function J({product:c,onSelect:i,handleClear:v}){const{name:h,productQuantity:f}=c;return e.jsxs("div",{onClick:()=>{i(c),v()},className:"flex justify-between items-center gap-2 py-1 w-full px-5 hover:bg-slate-950/10 text-sm",children:[e.jsx("div",{className:"flex items-center gap-3 justify-start",children:e.jsx("h1",{className:"font-medium text-gray-700",children:h})}),e.jsx("div",{className:"",children:f>0?e.jsxs("span",{className:"bg-green-500/10 text-green-700 rounded px-2 flex gap-2",children:["Stock: ",e.jsx("span",{children:f})]}):e.jsx("span",{className:"bg-red-500/10 text-red-700 rounded px-2",children:"Stock out"})})]})}localStorage.getItem("id");function K({form:c,productList:i,productLoading:v,totalCalculator:h,subTotal:f,type:x}){const{list:I,loading:w,defaultStore:o}=k(n=>n.store),T=Q(),C=(n,j)=>{const l=c.getFieldValue("adjustInvoiceProduct"),u=i.find(t=>t.id===n),d=l.map((t,s)=>{var r;return s===j?{...t,productPurchasePrice:(r=u.stockInfo[0])==null?void 0:r.productPurchasePrice}:t});c.setFieldsValue({adjustInvoiceProduct:d}),h(j)},g=n=>{var t,s,r,y,m,P;const j=(s=(t=c.getFieldValue("adjustInvoiceProduct"))==null?void 0:t.find((S,F)=>F===n))==null?void 0:s.productId,l=i==null?void 0:i.find(S=>j===S.id);let u=null;(r=l==null?void 0:l.stockInfo[0])!=null&&r.productQuantity&&(u=e.jsxs("span",{children:[e.jsx("span",{className:"mr-1",children:"Stock: "}),e.jsx("span",{children:(y=l.stockInfo[0])==null?void 0:y.productQuantity})]}));let d=null;return(m=l==null?void 0:l.uom)!=null&&m.name&&(d=e.jsxs("span",{children:[e.jsx("span",{className:"mr-1",children:"UoM: "}),e.jsx("span",{children:`${l==null?void 0:l.uomValue}/${(P=l==null?void 0:l.uom)==null?void 0:P.name}`})]})),{stock:u,uom:d}},a=n=>{T(z({page:1,count:1e3,storeId:n})),c.setFieldsValue({adjustInvoiceProduct:[{}]})};return b.useEffect(()=>{o&&c.setFieldValue("storeId",o.id)},[o,c]),e.jsx(R,{className:"h-[calc(100vh-100px)]",headClass:"",bodyClass:"p-0",title:e.jsx(G,{className:"w-[450px]",form:c,totalCalculator:h}),extra:e.jsx(p.Item,{className:"mb-0",name:"storeId",rules:[{required:!0,message:"Store is required"}],children:e.jsx(N,{className:"w-[150px]",loading:w,showSearch:!0,onChange:a,placeholder:"Select a store",optionFilterProp:"children",children:I==null?void 0:I.map(n=>e.jsx(N.Option,{value:n.id,children:n.name},n.id))})}),children:e.jsx(p.List,{name:"adjustInvoiceProduct",rules:[{required:!0,message:"Product is required"}],children:(n,{add:j,remove:l})=>e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"max-h-[calc(100vh-220px)] overflow-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"font-Popins text-black bg-tableHeaderBg border-gray-200 sticky top-0 z-10",children:e.jsxs("tr",{children:[e.jsx("th",{className:"py-2 pl-2 text-left",children:"SL"}),e.jsx("th",{className:"py-2 pl-2 text-left",children:"Product"}),e.jsx("th",{className:"py-2 pl-2 text-left",children:"Price"}),e.jsx("th",{className:"py-2 pl-2 text-left",children:"Adjust QTY"}),e.jsx("th",{className:"py-2 pl-2 text-left",children:"Total"}),e.jsx("th",{className:"py-2 pl-2 text-left"})]})}),e.jsx("tbody",{className:"bg-tableBg",children:n.map(({key:u,name:d,...t},s)=>{var y;const r=g(s);return e.jsxs("tr",{className:`hover:bg-slate-900/10 py-1 ${s===n.length-1?"":"border-b"}`,children:[e.jsx("td",{className:"py-2 pl-2  align-top",children:s+1}),e.jsxs("td",{className:"py-2 pl-2 align-top min-w-[200px]",children:[e.jsx(p.Item,{...t,name:[d,"productId"],className:"mb-0 max-w-[250px]",rules:[{required:!0,message:"Product is required"}],children:e.jsx(N,{placeholder:"Select Product",showSearch:!0,loading:v,optionFilterProp:"children",filterOption:(m,P)=>P.children.toLowerCase().includes(m.toLowerCase()),onChange:m=>{C(m,s)},children:i==null?void 0:i.map(m=>e.jsx(N.Option,{value:m.id,children:m.name},m.id))})}),e.jsx("div",{className:"px-2",children:r.uom})]}),e.jsx("td",{className:"py-2 pl-2 align-top min-w-[80px]",children:e.jsx(p.Item,{...t,name:[d,"productPurchasePrice"],className:"mb-0 max-w-[150px]",rules:[{required:!0,message:"Price is required"}],children:e.jsx(V,{type:"number",size:"small",style:{width:"100%"},placeholder:"50000",onChange:()=>h(s)})})}),e.jsxs("td",{className:"py-2 pl-2 align-top min-w-[80px]",children:[e.jsx(p.Item,{...t,name:[d,"adjustQuantity"],rules:[{required:!0,message:"Adjust Quantity is required"}],className:"mb-0",children:e.jsx(V,{size:"small",placeholder:"50",onChange:()=>h(s)})}),e.jsx("div",{children:r.stock})]}),e.jsx("td",{className:"py-2 pl-2 align-top min-w-[80px]",children:e.jsx(p.Item,{children:e.jsx("span",{children:`${x==="Increment"?"+":"-"}${((y=f[s])==null?void 0:y.total)||0}`})})}),e.jsx("td",{className:"py-2 pl-2 align-top",children:e.jsx(p.Item,{children:e.jsx("button",{shape:"circle",className:"flex justify-center items-center hover:bg-black/40 rounded-md",onClick:()=>{l(d),h(s)},children:e.jsx(Y,{size:25})})})})]},u)})})]})}),e.jsx("div",{className:"flex items-center justify-center mt-2",children:e.jsx(O,{onClick:()=>j(),className:"flex items-center justify-center w-48",block:!0,icon:e.jsx(W,{}),children:"Add Item"})})]})})})}const D=Number(localStorage.getItem("id")),se=()=>{const{list:c,loading:i}=k(t=>t.accounts)||{},{list:v,loading:h}=k(t=>t.products),[f,x]=b.useState(!1),[I,w]=b.useState([]),[o,T]=b.useState("Increment"),C=L(),g=Q(),[a]=p.useForm(),n=async t=>{const s=t.adjustInvoiceProduct.map(r=>({productId:r.productId,adjustQuantity:r.adjustQuantity}));try{let r;t.adjustType==="Increment"?r={userId:D,adjustType:t.adjustType.toLowerCase(),creditId:t.accountId,note:t.note,adjustInvoiceProduct:s,storeId:t.storeId}:t.adjustType==="Decrement"&&(r={userId:D,adjustType:t.adjustType.toLowerCase(),debitId:t.accountId,note:t.note,adjustInvoiceProduct:s,storeId:t.storeId});const y=await g(U(r));y.payload.message==="success"?(a.resetFields(),x(!1),C(`/admin/adjust-inventory/${y.payload.data.id}`)):x(!1),x(!1)}catch{x(!1)}},j=()=>{const t=a.getFieldValue("adjustInvoiceProduct"),s=(t==null?void 0:t.reduce((r,y)=>{const m=y.productPurchasePrice||0,P=y.adjustType,S=y.adjustQuantity||0,F=m*S;let A=0;return P==="increment"||P==="decrement"?A=m*S:A=F,[...r,{total:A,adjustQuantity:S}]},[]))||[];w(s)},l=t=>{T(t)},u=I.reduce((t,s)=>t+s.total,0),d=I.reduce((t,s)=>t+s.adjustQuantity,0);return b.useEffect(()=>{g(z({page:1,count:1e3})),g(H())},[g]),e.jsx(p,{form:a,className:"w-full ",name:"dynamic_form_nest_item",onFinish:n,onFinishFailed:()=>{x(!1)},layout:"vertical",size:"large",autoComplete:"off",initialValues:{date:M()},children:e.jsxs("div",{className:"flex gap-2 2xl:h-[calc(100vh-100px)] min-h-[500px]",children:[e.jsx("div",{className:"w-[70%] 2xl:w-[75%]",children:e.jsx(K,{totalCalculator:j,subTotal:I,form:a,type:o,productList:v,productLoading:h})}),e.jsx("div",{className:"flex flex-col w-[30%] 2xl:w-[25%] 2xl:h-[calc(100vh-80px)]",children:e.jsxs("div",{className:"flex-grow 2xl:overflow-y-auto 2xl:overflow-x-hidden  pl-2",children:[e.jsx(p.Item,{name:"adjustType",label:"Select Adjust Type",className:"mb-0",rules:[{required:!0,message:"Please select Adjust Type!"}],children:e.jsxs(N,{onChange:l,placeholder:"Select Adjust Type",children:[e.jsx(N.Option,{value:"Increment",children:"Increment"},"increment"),e.jsx(N.Option,{value:"Decrement",children:"Decrement"},"decrement")]})}),e.jsx(p.Item,{className:"-mb-2",name:"date",label:"Date",required:!0,rules:[{required:!0,message:"Please input Date!"}],children:e.jsx(Z,{size:"small",format:"YYYY-MM-DD",className:"date-picker"})}),e.jsx(p.Item,{className:"-mb-2",label:"Select Account",name:"accountId",required:!0,rules:[{required:!0,message:"Please select account!"}],children:e.jsx(N,{loading:i,popupClassName:"min-w-[200px]",placeholder:"Select Account",optionFilterProp:"children",filterOption:(t,s)=>s.children.includes(t),filterSort:(t,s)=>t.children.toLowerCase().localeCompare(s.children.toLowerCase()),children:c==null?void 0:c.map(t=>e.jsx(N.Option,{value:t.id,children:t.name},t.id))})}),e.jsx(p.Item,{name:"note",label:"Note",className:"-mb-2",children:e.jsx("textarea",{className:"w-full border-2 rounded p-2 outline-none",rows:3,placeholder:"Write about adjustment..."})}),e.jsx("div",{className:"bg-gray-100 px-2 my-5",children:e.jsxs("div",{className:"py-2",children:[e.jsxs("div",{className:" flex justify-between",children:[e.jsxs("span",{children:["Total"," ",`${o==="Increment"?"Increment":"Decrement"}`," ","Quantity:"," "]}),e.jsxs("strong",{children:[" ",`${o==="Increment"?"+":"-"}`,Number(d)," "]})]}),e.jsxs("div",{className:" flex justify-between",children:[e.jsx("span",{children:"Total Amount: "}),e.jsxs("strong",{children:[Number(u).toFixed(2)," "]})]})]})}),e.jsx(p.Item,{className:"-mt-0",children:e.jsx(O,{block:!0,type:"primary",htmlType:"submit",loading:f,onClick:()=>x(!0),children:"Create Adjust Inventory"})})]})})]})})};export{se as default};
